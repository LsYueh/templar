# TeMPlar
`TMP`是臺灣證券交易所（TWSE）所使用的專屬傳輸協定，全名為`Transaction Message Protocol`，用於證券交易相關的訊息傳輸。此工具用於解析TMP提供的`委託`/`成交`/`申報`/`檔案傳輸`服務訊息內容，將序列化的字串資料轉為非序列化的資料物件後再加以利用。

<br>

參考資料：
- `O-101-A10 主機連線電腦作業手冊`  
- `O-105-A10 TCPIP網路主機連線電腦作業手冊`  

<br><br>

# 專案結構

```console
{project-root}
 ├─ lib
 │   ├─ field
 │   │   ├─ cobol  <--------- COBOL格式解析
 │   │   ├─ data-type.js
 │   │   └─ field.js.js  <--- 欄位轉換
 │   ├─ message  <----------- 訊息解析
 │   ├─ spec
 │   │   ├─ message  <------- TMP格式訊息欄位組成定義
 │   │   │   ├─ body
 │   │   │   └─ header.js
 │   │   └─ messages  <------ 交易所電文種類定義
 │   │       ├─ otc.js
 │   │       └─ tse.js
 │   └─ meta.js
 └─ templar.js
```

<br><br>

# COBOL PICTURE Clause 處理
TMP電文中除`X`與`9`的文字解析外，還支援各種COBOL的`S9`有正負號的數字字串轉換

|  數 字  | ca,<br>cb,<br>cm,<br>cr<br>Positive | ci,<br>cn<br>Positive | ca,<br>ci,<br>cn<br>Negative | cb<br>Negative | cm<br>Negative | cr<br>Negative |
| :---- | :---- | :------ | :------ | :------ | :------ | :------ |
| 0 | '0' | '{' | '}' | '@' | 'p' | ' ' (space) |
| 1 | '1' | 'A' | 'J' | 'A' | 'q' | '!' |
| 2 | '2' | 'B' | 'K' | 'B' | 'r' | '"' (double-quote) |
| 3 | '3' | 'C' | 'L' | 'C' | 's' | '#' |
| 4 | '4' | 'D' | 'M' | 'D' | 't' | '$' |
| 5 | '5' | 'E' | 'N' | 'E' | 'u' | '%' |
| 6 | '6' | 'F' | 'O' | 'F' | 'v' | '&' |
| 7 | '7' | 'G' | 'P' | 'G' | 'w' | ''' (single-quote) |
| 8 | '8' | 'H' | 'Q' | 'H' | 'x' | '(' |
| 9 | '9' | 'I' | 'R' | 'I' | 'y' | ')' |

<br>

|  選 項  | 對 應 COBOL |
| :----: | :---- |
| ca | RM/COBOL (not RM/COBOL-85) |
| cb | MBP COBOL |
| ci | IBM COBOL (RM/COBOL-85) |
| cm | Micro Focus COBOL |
| cn | NCR COBOL |
| cr | Realia COBOL |
| cv | VAX COBOL |

<br>

COBOL的`S9`對正負號數字表示範例 (IBM COBOL)
```cobol
PIC S9(3) VALUE -123.
TRAILING                 '1'   '2'   'L'
TRAILING SEPARATE  '1'   '2'   '3'   '-'
LEADING                  'J'   '2'   '3'
LEADING SEPARATE   '-'   '1'   '2'   '3'

PIC S9(5)V9 VALUE -12345.6.
TRAILING                '1'  '2'  '3'  '4'  '5'  'O'
TRAILING SEPARATE  '1'  '2'  '3'  '4'  '5'  '6'  '-'
LEADING                 'J'  '2'  '3'  '4'  '5'  '6'
LEADING SEPARATE   '-'  '1'  '2'  '3'  '4'  '5'  '6'
```

<br><br>

# 交易所TMP連線架構

PVC：Permanent Virtual Circuit（永久虛擬電路）

## 實體線

一條實體線上可建立多條PVC，每10條PVC為一組。

|  PVC<br>或<br>PORT NO | 執行功能 |
| :----: | :----: |
| 01 | FT送 |
| 02 | FT收 |
| 03 | 成交回報 |
| 04 | 委託輸入 |
| 05 | 委託輸入 |
| 06 | 委託輸入 |
| 07 | 委託輸入 |
| 08 | 委託輸入 |
| 09 | 委託輸入 |

<br>

## PVC作業時間表

|     PVC   |  時 間  | 執 行 業 務 |
|   :----:  | :----: | :------: |
| (01)<br>FT 送  | 07:30－19:00 | 單筆訊息及檔案傳輸<br>(證券商的傳送線路) |
| (02)<br>FT 收  | 07:30－19:00 | 單筆訊息及檔案傳輸<br>(證券商的傳送線路) |
| (03)<br>成交回報 | 08:30－14:40 | 成交回報接收 |
| (04~09)<br>委託輸入 | 08:30－13:30<br>09:00－12:10<br>09:00－13:30<br>13:40－14:30<br>14:00－14:30<br>14:30－15:00<br>15:00－16:00<br>15:00－16:00 | 普通股交易<br>標借交易<br>盤中零股交易<br>盤後零股交易<br>盤後定價交易<br>證金標購交易<br>拍賣交易<br>標購交易 |

<br>

## 連線子系統

|   時 間   |  證 券 商 與 證 交 所  |
|  :----:  | ---- |
| 07:30<br>｜<br>08:20 | 1.開機通知作業<br>2.登錄作業<br>&emsp;準備進入連線狀態 |
| 08:20以後 | 完成連線進入各應用子統統 |
| 08:30<br>｜<br>19:00 | 1.進行各項業務<br>2.若在各項業務處理中發現有任何異常狀況時<br>&emsp;(1)開機通知作業<br>&emsp;(2)登錄作業<br>&emsp;&emsp;重新進入連線狀態 |
| 19:00以後 | 1.完成各項業務<br>2.離線作業<br>&emsp;雙方進入離線狀態 |

### 訊息格式
> MESSAGE ID︰L010、L020、L030、L040、L050、L060、L070、L080

<br>

## 單筆訊息與檔案傳輸通訊協定

|   時 間   |  系 統  |  功 能  |
|  :----:  | :----: | ------ |
| 07:30<br>｜<br>08:00 | 連線子系統 | 建立證交所與證券商的電腦連線作業，並進入業務系統。 |
| 08:00<br>｜<br>19:00 | 單筆訊息與檔案傳輸子系統<br>結算作業<br>申購作業<br>投資人管理作業 | 提供交易報表。<br>補送成交回報資料給證券商。<br>申購作業。<br>處理結算業務。<br>處理申購業務。<br>處理與投資人管理有關之業務。 |
| 19:00 | 連線子系統 | 離線 |

### 訊息格式 (傳送功能)
> MESSAGE ID︰F010、F020、F030(F210)、F040(F220)、F050、F060、F070、F080  

### 訊息格式 (接收功能)
> MESSAGE ID︰F090、F100、F110(F230)、F120(F240)、F130、F140、F150、F160  

### 訊息格式
> MESSAGE ID︰F170、F180、F190、F200


<br>

## 委託輸入通訊協定

|   時 間   |  系 統  |  功 能  |
|  :----:  | :----: | ------ |
| 08:00－08:30 | 連線子系統 | 建立證交所與證券商的電腦連線作業，並進入業務系統。 |
| 08:30－13:30<br>09:00－12:10<br>09:00－13:30<br>13:40－14:30<br>14:00－14:30<br>14:30－15:00<br>15:00－16:00<br>15:00－16:00 | 普通股交易子系統<br>標借交易子系統<br>盤中零股交易子系統<br>盤後零股交易子系統<br>盤後定價交易子系統<br>證金標購交易子系統<br>拍賣交易子系統<br>標購交易子系統 | 證券商輸入買賣委託，並接受證交所的委託回報。 |
| 16:00 | 連線子系統 | 結束委託輸入，回到連線子系統。<br>離線 |

### 訊息格式
> MESSAGE ID︰T1、T2、T3、T4、T5、T6、T7

<br>

## 成交回報通訊協定

|   時 間   |  系 統  |  功 能  |
|  :----:  | :----: | ------ |
| 08:00<br>｜<br>08:30 | 連線子系統 | 建立證交所與證券商的電腦連線作業，並進入業務系統。 |
| 08:30<br>｜<br>14:00 | 成交回報接收子系統 | 接收普通股、盤中零股成交回報資料。 |
| 14:00<br>｜<br>14:40 | 成交回報接收子系統 | 接收盤後定價、盤後零股成交回報資料。 |
| 14:40 | 連線子系統 | 結束委託輸入，回到連線子系統。<br>離線 |

### 訊息格式
> MESSAGE ID︰R1、R2、R3、R4、R5、R6


<br>

[TWSE 國內業務宣導網站](https://dsp.twse.com.tw/)  
